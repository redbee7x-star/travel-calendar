import React, { useState, useEffect, useMemo, useCallback } from 'react';
import { initializeApp } from 'firebase/app';
import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from 'firebase/auth';
import { getFirestore, collection, onSnapshot, doc, addDoc, deleteDoc } from 'firebase/firestore';

// --- Configuration and Global Variables ---
const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

// Helper to format date to YYYY-MM-DD
const formatDate = (date) => date.toISOString().split('T')[0];

// FIX: Sanitize appId to prevent Firebase path segmentation errors (replaces slashes with dashes)
const sanitizedAppId = appId.replace(/\//g, '-');

// --- Event Card Component (Moved outside App for React stability FIX) ---
const EventCard = ({ event, userId, onSetEventToDelete }) => {
    const isOwner = event.ownerId === userId;
    let bookingLink = '';
    let isBookingValid = false;
    
    if (event.booking) {
      const bookingText = event.booking.trim();
      // Ensure the link starts with https:// if it doesn't already
      bookingLink = bookingText.startsWith('http') ? bookingText : `https://${bookingText}`;
      try {
        new URL(bookingLink);
        isBookingValid = true;
      } catch (e) {
        isBookingValid = false;
      }
    }

    return (
      <div className="p-4 border border-gray-300 rounded bg-white shadow-lg">
        <h4 className="text-lg font-bold text-gray-900">{event.name}</h4>
        <p className="text-sm text-gray-700">Date: {event.date}</p>
        {event.city && <p className="text-sm text-gray-700">Location: {event.city}</p>}

        {event.image && (
          <div className="mt-2">
            <img 
              src={event.image} 
              onError={(e) => {
                e.target.onerror = null; 
                e.target.src='https://placehold.co/400x100/f3f4f6/374151?text=Poster+Unavailable'; // Light theme placeholder
              }} 
              className="w-full h-24 object-cover rounded" 
              alt="Event Poster"
            />
          </div>
        )}

        {isBookingValid ? (
          <p className="mt-2 text-sm">
            Booking: <a href={bookingLink} target="_blank" rel="noopener noreferrer" className="text-blue-600 hover:underline truncate">{event.booking}</a>
          </p>
        ) : event.booking && (
            <p className="mt-2 text-sm text-gray-500">Booking: {event.booking} (Link Invalid)</p>
        )}
        
        {isOwner && (
          <>
            <p className="text-xs text-yellow-600 mt-2">You are the owner of this event.</p>
            <button
              onClick={() => onSetEventToDelete(event)}
              className="mt-3 py-1 px-3 bg-red-600 hover:bg-red-700 text-white text-xs font-semibold rounded transition duration-150"
            >
              Delete Event
            </button>
          </>
        )}
      </div>
    );
};

const App = () => {
  const [db, setDb] = useState(null);
  const [auth, setAuth] = useState(null);
  const [userId, setUserId] = useState(null);
  const [isAuthReady, setIsAuthReady] = useState(false);
  const [currentMonth, setCurrentMonth] = useState(new Date());
  const [allEvents, setAllEvents] = useState({});
  const [formMessage, setFormMessage] = useState({ text: '', type: '' });
  const [selectedDate, setSelectedDate] = useState(null);
  const [eventToDelete, setEventToDelete] = useState(null);

  // --- 1. FIREBASE INITIALIZATION AND AUTHENTICATION ---
  useEffect(() => {
    if (!firebaseConfig) {
      console.error("Firebase configuration missing.");
      setFormMessage({ text: "Error: Firebase configuration missing.", type: 'error' });
      return;
    }

    try {
      const app = initializeApp(firebaseConfig);
      const firestore = getFirestore(app);
      const firebaseAuth = getAuth(app);
      setDb(firestore);
      setAuth(firebaseAuth);

      const unsubscribe = onAuthStateChanged(firebaseAuth, async (user) => {
        if (user) {
          setUserId(user.uid);
          console.log("User authenticated:", user.uid);
        } else {
          try {
            // Sign in anonymously if no token is available or user is logged out
            await signInAnonymously(firebaseAuth);
          } catch (error) {
            console.error("Anonymous sign-in failed:", error);
          }
        }
        setIsAuthReady(true);
      });

      // Handle custom token sign-in
      if (initialAuthToken) {
        signInWithCustomToken(firebaseAuth, initialAuthToken).catch(err => {
          console.error("Custom token sign-in failed:", err);
          setIsAuthReady(true); // Allow process to continue even on failure
        });
      }

      return () => unsubscribe();
    } catch (error) {
      console.error("Firebase initialization failed:", error);
      setFormMessage({ text: `Error: Firebase Init failed.`, type: 'error' });
      setIsAuthReady(true);
    }
  }, []);

  // --- 2. DATA LISTENER (REAL-TIME READ) ---
  useEffect(() => {
    if (!db || !isAuthReady) return;

    // FIX: Use sanitizedAppId for collection path
    const eventsRef = collection(db, 'artifacts', sanitizedAppId, 'public', 'data', 'events');
    
    const unsubscribe = onSnapshot(eventsRef, (snapshot) => {
      const newEvents = {};
      snapshot.forEach(doc => {
        const data = doc.data();
        const eventDate = data.date; 
        
        if (!newEvents[eventDate]) newEvents[eventDate] = [];
        
        newEvents[eventDate].push({
          id: doc.id,
          ...data
        });
      });
      setAllEvents(newEvents);
      // Re-render details for the selected day if it's currently active
      if (selectedDate) {
        setSelectedDate(prev => prev);
      }
      console.log("Events updated from Firestore.");
    }, (error) => {
      console.error("Error listening to events:", error);
      setFormMessage({ text: `Error fetching events: ${error.message}`, type: 'error' });
    });

    return () => unsubscribe();
  }, [db, isAuthReady, selectedDate]);

  // --- 3. CRUD OPERATION ---
  const getPublicDataCollectionRef = useCallback(() => {
    if (!db) return null;
    // FIX: Use sanitizedAppId for collection path
    return collection(db, 'artifacts', sanitizedAppId, 'public', 'data', 'events');
  }, [db]);

  const handleAddEvent = async (e) => {
    e.preventDefault();
    if (!userId || !db) {
      setFormMessage({ text: "Authentication not complete. Cannot save event.", type: 'error' });
      return;
    }

    const form = e.target;
    const date = form['event-date'].value;
    const name = form['event-name'].value.trim();
    const city = form['event-city'].value.trim();
    const image = form['event-image'].value.trim();
    const booking = form['event-booking'].value.trim();
    
    if (!date || !name) {
      setFormMessage({ text: "Date and Name are required.", type: 'error' });
      return;
    }

    const eventData = { date, name, city, image, booking, ownerId: userId, createdAt: new Date().toISOString() };
    
    try {
      await addDoc(getPublicDataCollectionRef(), eventData);
      setFormMessage({ text: "Event saved successfully!", type: 'success' });
      form.reset();
    } catch (e) {
      console.error("Error adding document: ", e);
      setFormMessage({ text: `Error saving event: ${e.message}`, type: 'error' });
    }
    setTimeout(() => setFormMessage({ text: '', type: '' }), 3000);
  };

  const handleDeleteEvent = async () => {
    if (!eventToDelete) return;
    
    if (eventToDelete.ownerId !== userId) {
      setFormMessage({ text: "You can only delete events you created.", type: 'error' });
      setEventToDelete(null);
      return;
    }

    try {
      await deleteDoc(doc(getPublicDataCollectionRef(), eventToDelete.id));
      setFormMessage({ text: "Event deleted successfully!", type: 'success' });
    } catch (e) {
      console.error("Error deleting document: ", e);
      setFormMessage({ text: `Error deleting event: ${e.message}`, type: 'error' });
    }
    setEventToDelete(null);
    setSelectedDate(null);
    setTimeout(() => setFormMessage({ text: '', type: '' }), 3000);
  };

  // --- 4. CALENDAR RENDERING LOGIC ---
  const currentMonthData = useMemo(() => {
    const year = currentMonth.getFullYear();
    const month = currentMonth.getMonth();
    const monthName = currentMonth.toLocaleString('en-us', { month: 'long', year: 'numeric' });

    const firstDayOfMonth = new Date(year, month, 1);
    const daysInMonth = new Date(year, month + 1, 0).getDate();
    const startDayOfWeek = firstDayOfMonth.getDay(); 

    const days = [];
    for (let i = 0; i < startDayOfWeek; i++) {
      days.push({ type: 'empty' });
    }

    const todayDateString = formatDate(new Date());

    for (let day = 1; day <= daysInMonth; day++) {
      const date = new Date(year, month, day);
      const dateString = formatDate(date);
      const eventsOnDay = allEvents[dateString] || [];
      
      days.push({
        type: 'day',
        day,
        dateString,
        isToday: dateString === todayDateString,
        events: eventsOnDay,
      });
    }

    return { monthName, days };
  }, [currentMonth, allEvents]);

  const handleDayClick = (dateString) => {
    setSelectedDate(dateString);
  };

  // --- 5. RENDER UI ---
  // Updated text colors for light theme
  const msgClass = formMessage.type === 'error' ? 'text-red-600' : 'text-green-600';
  const isSaveDisabled = !userId || !db;

  return (
    <div className="p-4 md:p-8 min-h-screen bg-gray-100 text-gray-900">
      <header className="text-center mb-8 max-w-7xl mx-auto">
        <h1 className="text-4xl font-extrabold text-blue-600 mb-2">Global Festival Calendar (React)</h1>
        <p className="text-gray-600">Collaborative event management using Firestore.</p>
        <p className="text-sm text-yellow-600 mt-2">
          User ID: {isAuthReady ? userId : 'Connecting to the timeline...'} | Status: {userId ? 'Authenticated' : 'Anonymous'}
        </p>
      </header>

      <div className="max-w-7xl mx-auto grid grid-cols-1 lg:grid-cols-3 gap-8">
        
        {/* Calendar View */}
        <div className="lg:col-span-2 bg-white border border-gray-300 rounded-xl p-4 shadow-xl">
          <div className="flex justify-between items-center mb-4">
            <button 
              onClick={() => setCurrentMonth(new Date(currentMonth.setMonth(currentMonth.getMonth() - 1)))}
              className="text-gray-700 p-2 rounded-full hover:bg-gray-200 transition duration-150"
            >
              <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m15 18-6-6 6-6"/></svg>
            </button>
            <h2 className="text-2xl font-semibold text-gray-900">{currentMonthData.monthName}</h2>
            <button 
              onClick={() => setCurrentMonth(new Date(currentMonth.setMonth(currentMonth.getMonth() + 1)))}
              className="text-gray-700 p-2 rounded-full hover:bg-gray-200 transition duration-150"
            >
              <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m9 18 6-6-6-6"/></svg>
            </button>
          </div>
          
          <div className="grid grid-cols-7 gap-0.5 text-center">
            {['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'].map(day => (
              <div key={day} className="bg-gray-300 text-gray-700 p-2 font-semibold text-sm">{day}</div>
            ))}
            
            {currentMonthData.days.map((dayData, index) => (
              <div 
                key={index}
                className={`p-3 border border-gray-300 text-sm h-24 relative transition duration-100 ${
                  dayData.type === 'empty' 
                    ? 'bg-gray-200' 
                    : dayData.events.length > 0 
                      ? 'bg-blue-100 hover:bg-blue-200 cursor-pointer has-event' 
                      : 'bg-white hover:bg-gray-100 cursor-pointer'
                } ${dayData.isToday ? 'border-2 border-blue-600 today' : ''}`}
                onClick={() => dayData.type === 'day' && handleDayClick(dayData.dateString)}
              >
                {dayData.type === 'day' && (
                  <>
                    <div className="font-bold mb-1">{dayData.day}</div>
                    {dayData.events.length > 0 && (
                      <>
                        <span className="absolute top-1 right-1 text-xs px-1 bg-blue-600 text-white rounded-full">
                          {dayData.events.length}
                        </span>
                        <p className="text-xs truncate text-gray-800 mt-1">{dayData.events[0].name}</p>
                      </>
                    )}
                  </>
                )}
              </div>
            ))}
          </div>
        </div>

        {/* Form and Details */}
        <div className="lg:col-span-1 space-y-8">
          
          <div className="bg-white border border-gray-300 rounded-xl p-6 shadow-xl">
            <h3 className="text-xl font-semibold mb-4 text-blue-600">Add New Event</h3>
            <form onSubmit={handleAddEvent} className="space-y-3">
              <input type="date" name="event-date" required defaultValue={formatDate(new Date())} className="w-full p-2 bg-white border border-gray-300 rounded text-gray-900 focus:ring focus:ring-blue-500"/>
              <input type="text" name="event-name" placeholder="Festival / Event Name (Required)" required className="w-full p-2 bg-white border border-gray-300 rounded text-gray-900 focus:ring focus:ring-blue-500"/>
              <input type="text" name="event-city" placeholder="Country / City" className="w-full p-2 bg-white border border-gray-300 rounded text-gray-900 focus:ring focus:ring-blue-500"/>
              <input type="url" name="event-image" placeholder="Event Poster/Image URL (Optional)" className="w-full p-2 bg-white border border-gray-300 rounded text-gray-900 focus:ring focus:ring-blue-500"/>
              <textarea name="event-booking" placeholder="Booking Links (Optional)" rows="2" className="w-full p-2 bg-white border border-gray-300 rounded text-gray-900 focus:ring focus:ring-blue-500"></textarea>
              <button 
                type="submit" 
                className="w-full py-2 bg-blue-600 hover:bg-blue-700 text-white font-bold rounded transition duration-150 disabled:opacity-50"
                disabled={isSaveDisabled}
              >
                {isSaveDisabled ? 'Authenticating...' : 'Save Event'}
              </button>
            </form>
            {formMessage.text && <p className={`mt-3 text-sm ${msgClass}`}>{formMessage.text}</p>}
          </div>

          <div className="bg-white border border-gray-300 rounded-xl p-6 shadow-xl">
            <h3 className="text-xl font-semibold mb-4 text-blue-600">Selected Event Details</h3>
            <div className="space-y-4">
              {selectedDate && allEvents[selectedDate] ? (
                // FIX: Pass required props to EventCard
                allEvents[selectedDate].map(event => (
                  <EventCard 
                    key={event.id} 
                    event={event} 
                    userId={userId} 
                    onSetEventToDelete={setEventToDelete} 
                  />
                ))
              ) : (
                <p className="text-gray-600">Select a date on the calendar with an event marker.</p>
              )}
            </div>
          </div>
        </div>
      </div>

      {/* Delete Confirmation Modal */}
      {eventToDelete && (
        <div className="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 z-50">
          <div className="bg-white p-6 rounded-lg shadow-2xl max-w-sm w-full border border-gray-300">
            <h4 className="text-xl font-bold mb-4 text-red-600">Confirm Deletion</h4>
            <p className="mb-6 text-gray-900">Are you sure you want to delete the event: "<span className="font-semibold text-blue-600">{eventToDelete.name}</span>"?</p>
            <div className="flex justify-end space-x-3">
              <button 
                onClick={() => setEventToDelete(null)} 
                className="py-2 px-4 bg-gray-300 hover:bg-gray-400 rounded text-gray-800 transition"
              >
                Cancel
              </button>
              <button 
                onClick={handleDeleteEvent} 
                className="py-2 px-4 bg-red-600 hover:bg-red-700 rounded text-white font-bold transition"
              >
                Delete Permanently
              </button>
            </div>
          </div>
        </div>
      )}
    </div>
  );
};

export default App;
