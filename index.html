<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Festival Calendar</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load Inter font -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f7f7; /* Very light background */
        }
        /* Custom styles for the calendar grid */
        .day-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 2px;
        }
        .day-header {
            padding: 8px;
            text-align: center;
            font-weight: 600;
            color: #4a5568;
        }
        .calendar-day {
            min-height: 100px;
            padding: 8px;
            background-color: #ffffff;
            border: 1px solid #e2e8f0;
            cursor: pointer;
            transition: all 0.2s;
        }
        .calendar-day:hover {
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
        }
        .current-month {
            background-color: #fcfcfc;
        }
        /* Event Highlight in Orangish/Amber for contrast */
        .has-event {
            background-color: #fef3c7; /* Light Amber/Orange for event day (amber-100) */
            border-left: 4px solid #f59e0b; /* Darker Amber accent (amber-500) */
            position: relative;
        }
    </style>
    <!-- Load Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, onSnapshot, collection, query, addDoc, setDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";

        // IMPORTANT: Global variables provided by the environment
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // 1. Firebase Initialization
        let app;
        let db;
        let auth;
        let userId = null;
        let isAuthReady = false;

        const state = {
            currentDate: new Date(),
            festivals: [], // Stores all fetched festival objects
            eventsByDate: {} // Stores festivals grouped by 'YYYY-MM-DD'
        };

        const monthNames = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];
        const dayNames = ["Sun", "Mon", "Tue", "Wed", "Thu", "Fri", "Sat"];

        // --- Utility Functions ---

        function showMessage(message, isError = false) {
            const messageBox = document.getElementById('messageBox');
            messageBox.textContent = message;
            messageBox.className = `p-4 rounded-lg shadow-lg mb-4 text-white font-semibold transition-opacity duration-300 ${isError ? 'bg-red-600' : 'bg-green-600'}`;
            messageBox.style.opacity = 1;
            setTimeout(() => {
                messageBox.style.opacity = 0;
            }, 3000);
        }

        function formatDate(date) {
            const y = date.getFullYear();
            const m = String(date.getMonth() + 1).padStart(2, '0');
            const d = String(date.getDate()).padStart(2, '0');
            return `${y}-${m}-${d}`;
        }

        // --- Calendar Rendering ---

        function renderCalendar() {
            const { currentDate, eventsByDate } = state;
            const calendarGrid = document.getElementById('calendarGrid');
            const monthTitle = document.getElementById('monthTitle');

            if (!calendarGrid || !monthTitle) return;

            // Clear previous grid
            calendarGrid.innerHTML = '';

            const today = new Date();
            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();

            monthTitle.textContent = `${monthNames[month]} ${year}`;

            const firstDayOfMonth = new Date(year, month, 1).getDay(); // 0 for Sunday, 1 for Monday, etc.
            const daysInMonth = new Date(year, month + 1, 0).getDate();

            // 1. Render Day Headers
            dayNames.forEach(day => {
                const header = document.createElement('div');
                header.className = 'day-header bg-gray-200 rounded-t-lg shadow-sm';
                header.textContent = day;
                calendarGrid.appendChild(header);
            });

            // 2. Render Blank Days (Padding for the start of the month)
            for (let i = 0; i < firstDayOfMonth; i++) {
                const blank = document.createElement('div');
                blank.className = 'calendar-day bg-gray-100/50';
                calendarGrid.appendChild(blank);
            }

            // 3. Render Days of the Month
            for (let day = 1; day <= daysInMonth; day++) {
                const date = new Date(year, month, day);
                const dateString = formatDate(date);

                const dayElement = document.createElement('div');
                dayElement.className = 'calendar-day rounded-lg p-3 text-sm transition-transform hover:scale-[1.01] duration-150';

                // Check for current day styling
                const isToday = today.toDateString() === date.toDateString();
                let dayClasses = isToday ? 'bg-yellow-100 border-yellow-500' : 'current-month';

                // Check for events
                const events = eventsByDate[dateString] || [];
                if (events.length > 0) {
                    dayClasses += ' has-event'; // Uses the orangish styling defined in <style>
                }

                dayElement.className += ` ${dayClasses}`;
                dayElement.setAttribute('data-date', dateString);
                dayElement.onclick = () => showDayDetails(dateString);

                // Day number
                const dayNumber = document.createElement('div');
                dayNumber.className = 'font-bold text-lg mb-1';
                dayNumber.textContent = day;
                dayElement.appendChild(dayNumber);

                // Event list preview
                if (events.length > 0) {
                    const eventCount = document.createElement('div');
                    // Changed text color to dark amber to match the event highlight
                    eventCount.className = 'text-xs text-amber-800 font-semibold mt-1 truncate';
                    eventCount.textContent = `${events.length} Festival${events.length > 1 ? 's' : ''}`;
                    dayElement.appendChild(eventCount);
                }

                calendarGrid.appendChild(dayElement);
            }
        }

        function showDayDetails(dateString) {
            const events = state.eventsByDate[dateString] || [];
            const detailsPanel = document.getElementById('dayDetailsPanel');
            const detailsContent = document.getElementById('dayDetailsContent');

            // Set the form date to the clicked date
            document.getElementById('festivalDate').value = dateString;

            detailsContent.innerHTML = `
                <h3 class="text-2xl font-bold mb-4 text-gray-800">${dateString}</h3>
            `;

            if (events.length === 0) {
                detailsContent.innerHTML += `<p class="text-gray-500 italic">No festivals scheduled for this day.</p>`;
            } else {
                events.forEach(event => {
                    // Using Amber colors for the event card
                    detailsContent.innerHTML += `
                        <div class="bg-amber-50 p-4 mb-3 rounded-xl border border-amber-300 shadow-sm transition-all duration-300 hover:shadow-lg hover:border-amber-400">
                            <!-- Image Display -->
                            ${event.imageUrl ? `
                                <img src="${event.imageUrl}"
                                     alt="${event.name} image"
                                     class="rounded-lg mb-3 w-full h-32 object-cover border border-amber-300"
                                     onerror="this.onerror=null;this.src='https://placehold.co/400x128/fcd34d/333?text=Image+Not+Found';">
                            ` : ''}

                            <div class="flex justify-between items-start">
                                <h4 class="text-xl font-semibold text-gray-900">${event.name}</h4>
                                <button onclick="deleteFestival('${event.id}')" class="text-gray-500 hover:text-gray-700 transition-colors flex-shrink-0 ml-2">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                        <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 10-2 0v6a1 1 0 102 0V8z" clip-rule="evenodd" />
                                    </svg>
                                </button>
                            </div>
                            <!-- Location Display -->
                            ${event.location ? `
                                <p class="text-gray-600 text-sm mt-1 flex items-center">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1 text-gray-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.828 0l-4.243-4.243a8 8 0 1111.314 0z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"/></svg>
                                    ${event.location}
                                </p>
                            ` : ''}
                            <p class="text-gray-700 mt-2">${event.description || 'No description provided.'}</p>

                            <!-- Links for Booking -->
                            <div class="mt-3 space-y-2">
                                ${event.flightUrl ? `
                                    <a href="${event.flightUrl}" target="_blank" class="block text-sm font-medium text-amber-700 hover:text-amber-900 transition-colors flex items-center">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"/></svg>
                                        Book Flights
                                    </a>
                                ` : ''}
                                ${event.hotelUrl ? `
                                    <a href="${event.hotelUrl}" target="_blank" class="block text-sm font-medium text-amber-700 hover:text-amber-900 transition-colors flex items-center">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h-2.5v-1.5a.5.5 0 00-.5-.5h-7a.5.5 0 00-.5.5V21H5m14 0v-9M5 21v-9m0 0h14"/></svg>
                                        Book Hotels
                                    </a>
                                ` : ''}
                            </div>
                        </div>
                    `;
                });
            }

            // Scroll to the panel for visibility on smaller screens
            detailsPanel.scrollIntoView({ behavior: 'smooth' });
        }

        // --- Calendar Navigation ---

        window.prevMonth = () => {
            state.currentDate.setMonth(state.currentDate.getMonth() - 1);
            renderCalendar();
        }

        window.nextMonth = () => {
            state.currentDate.setMonth(state.currentDate.getMonth() + 1);
            renderCalendar();
        }

        // --- Firestore Operations ---

        function getCollectionRef() {
            if (!db || !userId) {
                console.error("Firestore or User ID not initialized.");
                return null;
            }
            // Private user data path: /artifacts/{appId}/users/{userId}/festivals
            const collectionPath = `/artifacts/${appId}/users/${userId}/festivals`;
            return collection(db, collectionPath);
        }

        async function addFestival(event) {
            event.preventDefault();

            const name = document.getElementById('festivalName').value.trim();
            const date = document.getElementById('festivalDate').value;
            const description = document.getElementById('festivalDescription').value.trim();
            // NEW FIELDS
            const location = document.getElementById('festivalLocation').value.trim();
            const flightUrl = document.getElementById('festivalFlightUrl').value.trim();
            const hotelUrl = document.getElementById('festivalHotelUrl').value.trim();
            const imageUrl = document.getElementById('festivalImageUrl').value.trim();

            if (!name || !date) {
                showMessage("Please provide both a Festival Name and a Date.", true);
                return;
            }

            try {
                const festivalsRef = getCollectionRef();
                if (!festivalsRef) throw new Error("Could not get festivals collection reference.");

                await addDoc(festivalsRef, {
                    name: name,
                    date: date,
                    description: description,
                    location: location,
                    flightUrl: flightUrl,
                    hotelUrl: hotelUrl,
                    imageUrl: imageUrl,
                    createdAt: new Date(),
                });

                showMessage("Festival added successfully!");
                document.getElementById('addFestivalForm').reset();
            } catch (e) {
                console.error("Error adding document: ", e);
                showMessage("Failed to add festival. Check console for details.", true);
            }
        }
        window.addFestival = addFestival; // Expose to global scope for HTML event

        async function deleteFestival(docId) {
            try {
                const festivalsRef = getCollectionRef();
                if (!festivalsRef) throw new Error("Could not get festivals collection reference.");

                const docRef = doc(festivalsRef, docId);
                await deleteDoc(docRef);

                showMessage("Festival removed.");
            } catch (e) {
                console.error("Error deleting document: ", e);
                showMessage("Failed to delete festival. Check console for details.", true);
            }
        }
        window.deleteFestival = deleteFestival; // Expose to global scope for HTML event

        function setupFestivalListener() {
            if (!db || !userId) {
                console.error("Firestore or User ID is not ready for listener setup.");
                return;
            }

            try {
                const festivalsRef = getCollectionRef();
                const q = query(festivalsRef);

                onSnapshot(q, (snapshot) => {
                    const fetchedFestivals = [];
                    const eventsByDateMap = {};

                    snapshot.forEach((doc) => {
                        const data = doc.data();
                        const festival = { id: doc.id, ...data };
                        fetchedFestivals.push(festival);

                        // Group by date
                        if (!eventsByDateMap[festival.date]) {
                            eventsByDateMap[festival.date] = [];
                        }
                        eventsByDateMap[festival.date].push(festival);
                    });

                    // Sort festivals client-side (e.g., by date string)
                    fetchedFestivals.sort((a, b) => (a.date > b.date) ? 1 : -1);

                    state.festivals = fetchedFestivals;
                    state.eventsByDate = eventsByDateMap;

                    // Re-render the calendar and the current day's details
                    renderCalendar();
                    // Re-show details if a date is selected and events changed
                    const selectedDate = document.getElementById('festivalDate').value;
                    if (selectedDate) {
                        showDayDetails(selectedDate);
                    }
                }, (error) => {
                    console.error("Firestore Listener Error:", error);
                    showMessage("Error fetching real-time data.", true);
                });

            } catch (e) {
                console.error("Error setting up listener:", e);
                showMessage("Initialization error (Listener).", true);
            }
        }


        // --- Authentication and Setup ---

        async function initializeFirebase() {
            try {
                // Set debug logging for better visibility into Auth/Firestore issues
                setLogLevel('debug');
                
                // CRITICAL CHECK: Ensure the configuration is not empty
                if (Object.keys(firebaseConfig).length === 0) {
                    console.error("Firebase Configuration is empty. Cannot initialize app.");
                    showMessage("Critical Error: Missing Firebase configuration.", true);
                    return;
                }

                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                // Wait for authentication state to be determined
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                        document.getElementById('userIdDisplay').textContent = userId;
                        isAuthReady = true;
                        console.log("Firebase Auth Ready. User ID:", userId);
                        setupFestivalListener();
                    } else {
                        // Sign in anonymously if no token is available or if user is signed out
                        if (initialAuthToken) {
                            console.log("Signing in with custom token...");
                            await signInWithCustomToken(auth, initialAuthToken);
                        } else {
                            console.log("Signing in anonymously...");
                            await signInAnonymously(auth);
                        }
                    }
                });

            } catch (e) {
                console.error("Firebase Initialization Error: ", e);
                // Update the user message to reflect the failure
                showMessage(`Critical Error: Firebase failed to initialize. Check console for details. Error: ${e.message}`, true);
            }
        }

        // Run initialization on window load
        window.onload = initializeFirebase;
    </script>
</head>
<body class="min-h-screen p-4 sm:p-8">
    <div class="max-w-7xl mx-auto">
        <header class="text-center mb-10 p-6 bg-gray-900 text-white rounded-xl shadow-2xl">
            <h1 class="text-4xl sm:text-5xl font-extrabold tracking-tight">
                Festival Calendar
            </h1>
        </header>

        <div id="messageBox" class="opacity-0 transition-opacity duration-300"></div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <!-- Left Column: Calendar View -->
            <div class="lg:col-span-2 bg-white p-6 rounded-2xl shadow-xl">
                <div class="flex justify-between items-center mb-6">
                    <!-- Navigation buttons -->
                    <button onclick="prevMonth()" class="p-2 rounded-full bg-gray-200 hover:bg-gray-300 transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-900" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" /></svg>
                    </button>
                    <h2 id="monthTitle" class="text-3xl font-bold text-gray-800">Month Year</h2>
                    <button onclick="nextMonth()" class="p-2 rounded-full bg-gray-200 hover:bg-gray-300 transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-900" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" /></svg>
                    </button>
                </div>

                <div id="calendarGrid" class="day-grid bg-gray-300 rounded-lg overflow-hidden shadow-inner">
                    <!-- Calendar cells rendered by JavaScript -->
                </div>
            </div>

            <!-- Right Column: Add Event Form & Details Panel -->
            <div class="lg:col-span-1 space-y-8">
                <!-- Add New Festival Form -->
                <div class="bg-white p-6 rounded-2xl shadow-xl border-t-4 border-gray-900">
                    <h3 class="text-2xl font-bold mb-4 text-gray-900">Add New Festival</h3>
                    <form id="addFestivalForm" onsubmit="addFestival(event)">
                        <div class="mb-4">
                            <label for="festivalName" class="block text-sm font-medium text-gray-700">Festival Name</label>
                            <input type="text" id="festivalName" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-3 border focus:ring-gray-900 focus:border-gray-900">
                        </div>
                        <div class="mb-4">
                            <label for="festivalDate" class="block text-sm font-medium text-gray-700">Date</label>
                            <input type="date" id="festivalDate" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-3 border focus:ring-gray-900 focus:border-gray-900">
                        </div>
                        <!-- NEW FIELD: Location -->
                        <div class="mb-4">
                            <label for="festivalLocation" class="block text-sm font-medium text-gray-700">Location</label>
                            <input type="text" id="festivalLocation" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-3 border focus:ring-gray-900 focus:border-gray-900" placeholder="e.g., Miami, Florida">
                        </div>
                        <div class="mb-4">
                            <label for="festivalDescription" class="block text-sm font-medium text-gray-700">Description (Optional)</label>
                            <textarea id="festivalDescription" rows="2" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-3 border focus:ring-gray-900 focus:border-gray-900"></textarea>
                        </div>
                        <hr class="my-6 border-gray-200">
                        <h4 class="text-lg font-bold mb-3 text-gray-700">Travel & Media (Optional)</h4>
                        <!-- NEW FIELD: Flight URL -->
                        <div class="mb-4">
                            <label for="festivalFlightUrl" class="block text-sm font-medium text-gray-700">Book Flights (URL)</label>
                            <input type="url" id="festivalFlightUrl" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-3 border focus:ring-gray-900 focus:border-gray-900" placeholder="https://skyscanner.com/...">
                        </div>
                        <!-- NEW FIELD: Hotel URL -->
                        <div class="mb-4">
                            <label for="festivalHotelUrl" class="block text-sm font-medium text-gray-700">Book Hotels (URL)</label>
                            <input type="url" id="festivalHotelUrl" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-3 border focus:ring-gray-900 focus:border-gray-900" placeholder="https://airbnb.com/...">
                        </div>
                        <!-- NEW FIELD: Image URL -->
                        <div class="mb-6">
                            <label for="festivalImageUrl" class="block text-sm font-medium text-gray-700">Image (URL)</label>
                            <input type="url" id="festivalImageUrl" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-3 border focus:ring-gray-900 focus:border-gray-900" placeholder="https://example.com/festival.jpg">
                        </div>

                        <!-- Submit button -->
                        <button type="submit" class="w-full py-3 px-4 border border-transparent rounded-lg shadow-lg text-lg font-medium text-white bg-gray-800 hover:bg-gray-900 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-800 transition-all duration-200">
                            Save Festival
                        </button>
                    </form>
                </div>

                <!-- Day Details Panel -->
                <div id="dayDetailsPanel" class="bg-white p-6 rounded-2xl shadow-xl border-t-4 border-gray-900">
                    <h3 class="text-2xl font-bold mb-4 text-gray-900">Day Details</h3>
                    <div id="dayDetailsContent">
                        <p class="text-gray-500">Click on any day in the calendar to view its details and scheduled festivals.</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Footer / User Info -->
        <footer class="mt-10 pt-4 text-center text-sm text-gray-500 border-t border-gray-300">
            <p>Your Private Data ID: <code id="userIdDisplay" class="font-mono text-xs bg-gray-200 p-1 rounded-md text-gray-700 break-all">Loading User ID...</code></p>
            <p class="mt-1">All festival data is saved privately to this ID using Firestore.</p>
        </footer>
    </div>
</body>
</html>
